# ui_main.py
from __future__ import annotations

import os
import logging
from datetime import datetime
from typing import Optional

import pandas as pd

# QtCore
from PySide6.QtCore import (
    Qt, QTimer, Signal, Slot, QAbstractTableModel,
    QModelIndex, QSettings, QSortFilterProxyModel, QUrl
)

# QtWidgets
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QDialog, QMessageBox,
    QLabel, QPushButton, QVBoxLayout, QHBoxLayout, QStatusBar,
    QTableView, QHeaderView, QLineEdit, QToolBar, QListWidget,
    QTextEdit, QListWidgetItem, QTextBrowser, QSplitter, QCheckBox,
    QComboBox,
)

from core.detail_information_getter import DetailInformationGetter, SimpleMarketAPI
from core.macd_calculator import macd_bus  # noqa: F401 (ì—°ê²° ë³´ì¥ìš©)
from core.macd_dialog import MacdDialog

# âœ… ì„¤ì •/ì™€ì´ì–´ë§
from setting.settings_manager import SettingsStore, SettingsDialog
from setting.wiring import AppWiring

logger = logging.getLogger("ui_main")
logging.getLogger("matplotlib.font_manager").setLevel(logging.WARNING)


# ----------------------------
# DataFrame â†’ Qt ëª¨ë¸
# ----------------------------
class DataFrameModel(QAbstractTableModel):
    def __init__(self, df: pd.DataFrame = pd.DataFrame(), parent=None):
        super().__init__(parent)
        self._df = df.copy()

    def setDataFrame(self, df: pd.DataFrame):
        self.beginResetModel()
        self._df = df.copy()
        self.endResetModel()

    def rowCount(self, parent: QModelIndex = QModelIndex()):
        return 0 if parent.isValid() else len(self._df)

    def columnCount(self, parent: QModelIndex = QModelIndex()):
        return 0 if parent.isValid() else len(self._df.columns)

    def data(self, index: QModelIndex, role=Qt.DisplayRole):
        if not index.isValid() or role not in (Qt.DisplayRole, Qt.EditRole, Qt.ToolTipRole):
            return None
        value = self._df.iat[index.row(), index.column()]
        return "" if pd.isna(value) else str(value)

    def headerData(self, section, orientation, role=Qt.DisplayRole):
        if role != Qt.DisplayRole:
            return None
        if orientation == Qt.Horizontal:
            try:
                return str(self._df.columns[section])
            except Exception:
                return ""
        return ""  # ì„¸ë¡œ í—¤ë” ìˆ¨ê¹€


# ----------------------------
# ê³ ë„í™” UI MainWindow
# ----------------------------
class MainWindow(QMainWindow):
    """
    main.pyì—ì„œ ë„˜ê²¨ì£¼ëŠ” ê²ƒë“¤:
      - bridge: AsyncBridge ì¸ìŠ¤í„´ìŠ¤
      - engine: Engine ì¸ìŠ¤í„´ìŠ¤ (start_loop/initialize ë“± ë³´ìœ )
      - perform_filtering_cb: callable -> í•„í„° ì‹¤í–‰ í›„ ì¶œë ¥ ê²½ë¡œ(str) ë°˜í™˜ ê°€ëŠ¥
      - project_root: str
      - wiring: AppWiring (ì„ íƒ)
    """

    # ë¹„UI â†’ UI ìŠ¤ë ˆë“œ ì•ˆì „ ì „í™˜ìš© ì‹œê·¸ë„
    sig_new_stock_detail = Signal(dict)
    sig_trade_signal = Signal(dict)  # {"side","code","price","ts?"}

    def __init__(self, bridge, engine, perform_filtering_cb, project_root: str, wiring: AppWiring | None = None):
        super().__init__()
        self.setWindowTitle("ì¡°ê±´ê²€ìƒ‰ & MACD ëª¨ë‹ˆí„°")
        self.resize(1180, 760)

        self.bridge = bridge
        self.engine = engine
        self.perform_filtering_cb = perform_filtering_cb
        self.project_root = project_root
        self.wiring = wiring  # âœ… ì£¼ì…(ì„ íƒ)

        # âœ… ê²°ê³¼ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ (í‘œ ê¸°ë°˜ ë Œë”)
        self._result_rows = []     # [{"code","name","price","rt","vol","buy_price","sell_price","updated_at"}...]
        self._result_index = {}    # code -> index (upsert)

        # ë‹¤ì´ì–¼ë¡œê·¸/ìŠ¤íŠ¸ë¦¼ ìƒíƒœ
        self._macd_dialogs: dict[str, QDialog] = {}
        self._active_macd_streams: set[str] = set()
        self._last_stream_req_ts: dict[str, pd.Timestamp] = {}
        self._stream_debounce_sec: int = 15

        # ìƒë‹¨ íˆ´ë°” + ë ˆì´ì•„ì›ƒ
        self._build_toolbar()
        self._build_layout()

        # ìƒíƒœë°” + ì‹œê³„
        self.status = QStatusBar()
        self.setStatusBar(self.status)
        self.status.showMessage("ì¤€ë¹„ë¨")
        self._start_clock()
        self.label_new_stock = QLabel("ì‹ ê·œ ì¢…ëª© ì—†ìŒ")
        self.status.addPermanentWidget(self.label_new_stock)

        # ì‹œê·¸ë„ ì—°ê²°
        self._connect_signals()

        # ìŠ¤íƒ€ì¼
        self._apply_stylesheet()

        # ì´ˆê¸° ë¡œë”©
        if hasattr(self.engine, "start_loop"):
            self.engine.start_loop()
        self.load_candidates()

        # ìƒíƒœ ì €ì¥/ë³µì› + ì„¤ì • ë¡œë“œ/ì ìš©
        self._settings_qs = QSettings("Trade", "AutoTraderUI")
        state = self._settings_qs.value("hsplit_state")
        if state is not None:
            try:
                self.hsplit.restoreState(state)
            except Exception:
                pass

        # âœ… ì•± ì„¤ì • ë¡œë“œ â†’ Wiringì— ì ìš© â†’ UI ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
        self.store = SettingsStore()
        self.app_cfg = self.store.load()
        if self.wiring:
            self.wiring.apply_settings(self.app_cfg)

        # UI í† ê¸€ ì´ˆê¸°í™” (QSettings í˜¸í™˜ ìœ ì§€)
        auto_buy_saved = self._settings_qs.value("auto_buy")
        auto_sell_saved = self._settings_qs.value("auto_sell")
        self.cb_auto_buy.setChecked(bool(auto_buy_saved) if auto_buy_saved is not None else getattr(self.app_cfg, "auto_buy", False))
        self.cb_auto_sell.setChecked(bool(auto_sell_saved) if auto_sell_saved is not None else getattr(self.app_cfg, "auto_sell", False))

        # ì˜µì…˜: ìë™ ì˜¤í”ˆ off
        self.auto_open_macd_modal = False

    # ---- í† í° ê°±ì‹  ìˆ˜ì‹  ----
    def _on_token_ready(self, token: str):
        try:
            if not hasattr(self, "getter") or self.getter is None:
                self.getter = DetailInformationGetter(token=token)
            else:
                self.getter.token = token

            if not hasattr(self, "market_api") or self.market_api is None:
                self.market_api = SimpleMarketAPI(token=token)
            else:
                self.market_api.set_token(token)
        except Exception:
            pass

    # ---- ì‹ í˜¸ ì—°ê²° ----
    def _connect_signals(self):
        # ë²„íŠ¼/ì•¡ì…˜
        self.btn_init.clicked.connect(self.on_click_init)
        self.btn_start.clicked.connect(self.on_click_start_condition)
        self.btn_stop.clicked.connect(self.on_click_stop_condition)
        self.btn_filter.clicked.connect(self.on_click_filter)
        self.btn_settings.triggered.connect(self.on_open_settings_dialog)  # âœ… í™˜ê²½ì„¤ì •

        # ì…ë ¥/ëª©ë¡
        self.search_candidates.textChanged.connect(self._filter_candidates)
        self.search_conditions.textChanged.connect(self._filter_conditions)
        self.list_conditions.itemSelectionChanged.connect(self._update_cond_info)

        # ë¸Œë¦¬ì§€
        if hasattr(self.bridge, "log"):
            self.bridge.log.connect(self.append_log)
        if hasattr(self.bridge, "condition_list_received"):
            self.bridge.condition_list_received.connect(self.populate_conditions)
        if hasattr(self.bridge, "macd_series_ready"):
            try:
                self.bridge.macd_series_ready.connect(self.on_macd_series_ready, Qt.UniqueConnection)
            except TypeError:
                pass
        if hasattr(self.bridge, "macd_data_received"):
            try:
                self.bridge.macd_data_received.connect(self.on_macd_data, Qt.UniqueConnection)
            except TypeError:
                pass
        if hasattr(self.bridge, "new_stock_received"):
            self.bridge.new_stock_received.connect(self.on_new_stock)
        if hasattr(self.bridge, "token_ready"):
            self.bridge.token_ready.connect(self._on_token_ready)
        if hasattr(self.bridge, "new_stock_detail_received"):
            self.bridge.new_stock_detail_received.connect(self.on_new_stock_detail)

        # ë¹„UIâ†’UI í”„ë¡ì‹œ
        self.sig_new_stock_detail.connect(self.on_new_stock_detail)
        self.sig_trade_signal.connect(self.on_trade_signal)

        # ì—”ì§„ ì´ˆê¸°í™” ì™„ë£Œ
        if hasattr(self.engine, "initialization_complete"):
            self.engine.initialization_complete.connect(self.on_initialization_complete)

    # ---- ë ˆì´ì•„ì›ƒ ë¹Œë“œ ----
    def _build_layout(self):
        central = QWidget()
        self.setCentralWidget(central)
        root_layout = QHBoxLayout(central)
        main_split = QSplitter(Qt.Horizontal)
        root_layout.addWidget(main_split)

        # ì¢Œì¸¡ íŒ¨ë„
        left_panel = QWidget(self)
        left = QVBoxLayout(left_panel)
        self.search_conditions = QLineEdit(placeholderText="ì¡°ê±´ì‹ ê²€ìƒ‰â€¦")
        self.btn_init = QPushButton("ì´ˆê¸°í™” (í† í°+WS ì—°ê²°)")
        self.btn_start = QPushButton("ì„ íƒ ì¡°ê±´ ì‹œì‘")
        self.btn_stop = QPushButton("ì„ íƒ ì¡°ê±´ ì¤‘ì§€")
        self.btn_filter = QPushButton("ì¢…ëª© í•„í„°ë§ ì‹¤í–‰ (ì¬ë¬´+ê¸°ìˆ )")
        self.list_conditions = QListWidget()
        self.lbl_cond_info = QLabel("0ê°œ / ì„ íƒ: 0")

        # âœ… ìë™ë§¤ìˆ˜/ë§¤ë„ ì²´í¬ë°•ìŠ¤
        cb_row = QHBoxLayout()
        self.cb_auto_buy = QCheckBox("ìë™ë§¤ìˆ˜")
        self.cb_auto_sell = QCheckBox("ìë™ë§¤ë„")
        cb_row.addWidget(self.cb_auto_buy)
        cb_row.addWidget(self.cb_auto_sell)
        cb_row.addStretch(1)

        left.addWidget(self.search_conditions)
        left.addWidget(QLabel("ì¡°ê±´ì‹ ëª©ë¡"))
        left.addWidget(self.list_conditions, 1)
        left.addWidget(self.btn_init)
        left.addWidget(self.btn_filter)
        left.addLayout(cb_row)
        left.addWidget(self.lbl_cond_info)
        row_btns = QHBoxLayout()
        row_btns.addWidget(self.btn_start)
        row_btns.addWidget(self.btn_stop)
        left.addLayout(row_btns)
        main_split.addWidget(left_panel)

        # ìš°ì¸¡ íŒ¨ë„
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)

        # ìƒë‹¨(ì¢Œ/ìš°) + í•˜ë‹¨(ë¡œê·¸)
        vsplit = QSplitter(Qt.Vertical)
        right_layout.addWidget(vsplit, 1)

        # ìƒë‹¨ ì¢Œ/ìš°
        hsplit = QSplitter(Qt.Horizontal)
        self.hsplit = hsplit
        vsplit.addWidget(hsplit)

        # ìƒë‹¨-ì¢Œ: í›„ë³´ í…Œì´ë¸”
        pane_top_left = QWidget(self)
        top_left = QVBoxLayout(pane_top_left)
        top_left.addWidget(QLabel("25ì¼ì´ë‚´ ê¸‰ë“± ì¢…ëª©"))
        self.search_candidates = QLineEdit(pane_top_left, placeholderText="í›„ë³´ ì¢…ëª© ì‹¤ì‹œê°„ ê²€ìƒ‰â€¦")
        top_left.addWidget(self.search_candidates)

        self.cand_table = QTableView(pane_top_left)
        self.cand_model = DataFrameModel(pd.DataFrame(columns=["íšŒì‚¬ëª…", "ì¢…ëª©ì½”ë“œ", "í˜„ì¬ê°€"]))
        self.cand_proxy = QSortFilterProxyModel(self)
        self.cand_proxy.setSourceModel(self.cand_model)
        self.cand_proxy.setFilterCaseSensitivity(Qt.CaseInsensitive)
        self.cand_proxy.setFilterKeyColumn(-1)
        self.cand_table.setModel(self.cand_proxy)
        self.cand_table.setSortingEnabled(False)
        self.cand_table.horizontalHeader().setStretchLastSection(True)
        self.cand_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.cand_table.setSelectionBehavior(QTableView.SelectRows)
        self.cand_table.setAlternatingRowColors(True)
        self.cand_table.verticalHeader().setVisible(False)
        self.cand_table.setCornerButtonEnabled(False)
        top_left.addWidget(self.cand_table, 1)

        # ìƒë‹¨-ìš°: ê²°ê³¼ í‘œ ì˜ì—­
        pane_top_right = QWidget()
        top_right = QVBoxLayout(pane_top_right)
        top_right.addWidget(QLabel("ì¢…ëª© ê²€ìƒ‰ ê²°ê³¼"))

        # ì •ë ¬ UI
        sort_row = QHBoxLayout()
        self.cmb_sort_key = QComboBox()
        self.cmb_sort_key.addItems([
            "ë“±ë½ë¥ (%)", "í˜„ì¬ê°€", "ê±°ë˜ëŸ‰", "ë§¤ìˆ˜ê°€", "ë§¤ë„ê°€", "ì½”ë“œ", "ì´ë¦„", "ìµœê·¼ ê°±ì‹ ì‹œê°„"
        ])
        self.cmb_sort_key.setCurrentText("ìµœê·¼ ê°±ì‹ ì‹œê°„")  # ê°±ì‹  ìµœì‹ ìˆœ ë³´ì´ê¸° ì¢‹ê²Œ
        self.btn_sort_dir = QPushButton("ë‚´ë¦¼ì°¨ìˆœ")
        self.btn_sort_dir.setCheckable(True)  # ì²´í¬=ë‚´ë¦¼ì°¨ìˆœ
        self.btn_sort_dir.setChecked(True)
        sort_row.addWidget(QLabel("ì •ë ¬:"))
        sort_row.addWidget(self.cmb_sort_key)
        sort_row.addWidget(self.btn_sort_dir)
        sort_row.addStretch(1)
        top_right.addLayout(sort_row)

        # ì •ë ¬ ì´ë²¤íŠ¸ ì—°ê²°
        self.cmb_sort_key.currentIndexChanged.connect(lambda _ : self._render_results_html())
        self.btn_sort_dir.toggled.connect(lambda checked: (
            self.btn_sort_dir.setText("ë‚´ë¦¼ì°¨ìˆœ" if checked else "ì˜¤ë¦„ì°¨ìˆœ"),
            self._render_results_html()
        ))

        self.text_result = QTextBrowser()
        self.text_result.setOpenExternalLinks(False)
        self.text_result.setOpenLinks(False)
        self.text_result.setReadOnly(True)
        self.text_result.anchorClicked.connect(self._on_result_anchor_clicked)
        top_right.addWidget(self.text_result, 1)

        # ì¢Œ/ìš° ë“±ë¡
        hsplit.addWidget(pane_top_left)
        hsplit.addWidget(pane_top_right)
        hsplit.setSizes([680, 440])

        # í•˜ë‹¨: ë¡œê·¸
        pane_bottom = QWidget()
        bottom = QVBoxLayout(pane_bottom)
        bottom.addWidget(QLabel("ë¡œê·¸"))
        self.text_log = QTextEdit()
        self.text_log.setReadOnly(True)
        bottom.addWidget(self.text_log, 1)
        vsplit.addWidget(pane_bottom)
        vsplit.setSizes([540, 220])

        main_split.addWidget(right_panel)
        main_split.setSizes([380, 800])

    # ---- ìŠ¤íƒ€ì¼ ----
    def _apply_stylesheet(self):
        self.setStyleSheet("""
            QMainWindow, QWidget { background: #1f2124; color: #E6E6E6; }
            QLabel { color: #E6E6E6; }
            QLineEdit, QTextEdit, QListWidget, QTableView {
                background: #2a2d31; color: #E6E6E6; border: 1px solid #3a3d42;
                selection-background-color: #3d4650; selection-color: #ffffff;
                alternate-background-color: #26292d;
            }
            QLineEdit:focus, QTextEdit:focus { border: 1px solid #4d5661; }
            QPushButton {
                background: #2f3237; border: 1px solid #454a50; padding: 6px 10px;
                border-radius: 6px;
            }
            QPushButton:hover { background: #353a40; }
            QPushButton:pressed { background: #2a2e33; }
            QPushButton:disabled { color: #8b8f94; border-color: #3a3d42; }
            QTableView { gridline-color: #3a3d42; }
            QTableView::item:selected { background: #3d4650; }
            QHeaderView::section {
                background: #26292d; color: #E6E6E6; border: 0px; padding: 6px;
                border-bottom: 1px solid #3a3d42;
            }
            QStatusBar { background: #1b1d20; color: #cfd3d8; }
            QSplitter::handle { background: #2a2d31; }
        """)

    # ---- íˆ´ë°” ----
    def _build_toolbar(self):
        tb = QToolBar("Main")
        tb.setMovable(False)
        self.addToolBar(Qt.TopToolBarArea, tb)

        act_init = tb.addAction("ì´ˆê¸°í™”")
        act_init.setShortcut("Ctrl+I")
        act_init.triggered.connect(self.on_click_init)

        tb.addSeparator()
        act_start = tb.addAction("ì¡°ê±´ ì‹œì‘")
        act_start.setShortcut("Ctrl+S")
        act_start.triggered.connect(self.on_click_start_condition)

        act_stop = tb.addAction("ì¡°ê±´ ì¤‘ì§€")
        act_stop.setShortcut("Ctrl+E")
        act_stop.triggered.connect(self.on_click_stop_condition)

        tb.addSeparator()
        act_filter = tb.addAction("í•„í„° ì‹¤í–‰")
        act_filter.setShortcut("Ctrl+F")
        act_filter.triggered.connect(self.on_click_filter)

        act_refresh = tb.addAction("í›„ë³´ ìƒˆë¡œê³ ì¹¨")
        act_refresh.setShortcut("F5")
        act_refresh.triggered.connect(self.load_candidates)

        tb.addSeparator()
        self.btn_settings = tb.addAction("í™˜ê²½ì„¤ì •â€¦")  # âœ… ì„¤ì • ì§„ì…

    def _start_clock(self):
        self._clock = QLabel()
        self.status.addPermanentWidget(self._clock)
        t = QTimer(self)
        t.timeout.connect(lambda: self._clock.setText(datetime.now().strftime("%Y-%m-%d %H:%M:%S")))
        t.start(1000)
        self._clock_timer = t

    # ---- ì¢…ë£Œì‹œ ìƒíƒœ ì €ì¥ + ì—”ì§„ ì¢…ë£Œ ----
    def closeEvent(self, event):
        try:
            if hasattr(self, "hsplit"):
                try:
                    self._settings_qs.setValue("hsplit_state", self.hsplit.saveState())
                except Exception:
                    pass

            # QSettings í˜¸í™˜ ì €ì¥(ë³„ë„ SettingsStore.saveë„ ì•„ë˜ì„œ ìˆ˜í–‰)
            self._settings_qs.setValue("auto_buy", self.cb_auto_buy.isChecked())
            self._settings_qs.setValue("auto_sell", self.cb_auto_sell.isChecked())

            # ìµœì‹  cfg ë°˜ì˜ ì €ì¥
            setattr(self.app_cfg, "auto_buy", self.cb_auto_buy.isChecked())
            setattr(self.app_cfg, "auto_sell", self.cb_auto_sell.isChecked())
            self.store.save(self.app_cfg)

            if hasattr(self.engine, "shutdown"):
                self.engine.shutdown()

            for code6 in list(self._active_macd_streams):
                if hasattr(self.engine, "stop_macd_stream"):
                    self.engine.stop_macd_stream(code6)
        finally:
            event.accept()

    # ========================================================
    # ğŸ”’ ì™¸ë¶€(ì›¹ì†Œì¼“/async/ìŠ¤ë ˆë“œ)ì—ì„œ ì•ˆì „í•˜ê²Œ í˜¸ì¶œí•  í”„ë¡ì‹œ
    # ========================================================
    def threadsafe_new_stock_detail(self, payload: dict):
        try:
            self.sig_new_stock_detail.emit(payload)
        except Exception as e:
            self.append_log(f"[UI] emit ì‹¤íŒ¨: {e}")

    def threadsafe_trade_signal(self, payload: dict):
        """
        ì™¸ë¶€(íŠ¸ë ˆì´ë” ë“±)ì—ì„œ í˜¸ì¶œ: {"side":"BUY"|"SELL", "code":"166090", "price":41700, "ts": "...?"}
        """
        try:
            self.sig_trade_signal.emit(payload)
        except Exception as e:
            self.append_log(f"[UI] trade emit ì‹¤íŒ¨: {e}")

    # -------- ë²„íŠ¼ í•¸ë“¤ëŸ¬ --------
    def on_click_init(self):
        try:
            if getattr(self.engine, "_initialized", False):
                QMessageBox.information(self, "ì•ˆë‚´", "ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
                return
            self.engine.initialize()
            self.btn_init.setEnabled(False)
        except Exception as e:
            QMessageBox.critical(self, "ì´ˆê¸°í™” ì‹¤íŒ¨", str(e))

    def on_initialization_complete(self):
        self.status.showMessage("ì´ˆê¸°í™” ì™„ë£Œ: WebSocket ìˆ˜ì‹  ì‹œì‘", 3000)
        QMessageBox.information(self, "ì´ˆê¸°í™”", "ì´ˆê¸°í™” ì™„ë£Œ: WebSocket ìˆ˜ì‹  ì‹œì‘")

    def on_click_start_condition(self):
        item = self.list_conditions.currentItem()
        if not item:
            QMessageBox.warning(self, "ì•ˆë‚´", "ì‹œì‘í•  ì¡°ê±´ì‹ì„ ì„ íƒí•˜ì„¸ìš”.")
            return
        seq = item.data(Qt.UserRole) or ""
        self.engine.send_condition_search_request(seq)
        self.status.showMessage(f"ì¡°ê±´ê²€ìƒ‰ ì‹œì‘ ìš”ì²­: {seq}", 3000)

    def on_click_stop_condition(self):
        item = self.list_conditions.currentItem()
        if not item:
            QMessageBox.warning(self, "ì•ˆë‚´", "ì¤‘ì§€í•  ì¡°ê±´ì‹ì„ ì„ íƒí•˜ì„¸ìš”.")
            return
        seq = item.data(Qt.UserRole) or ""
        self.engine.remove_condition_realtime(seq)
        self.status.showMessage(f"ì¡°ê±´ê²€ìƒ‰ ì¤‘ì§€ ìš”ì²­: {seq}", 3000)

    def on_click_filter(self):
        try:
            out_path = self.perform_filtering_cb()
            self.append_log("âœ… í•„í„°ë§ ì™„ë£Œ (finance + technical)")
            self.load_candidates(out_path if isinstance(out_path, str) else None)
            self.status.showMessage("í•„í„°ë§ ì™„ë£Œ", 3000)
        except Exception as e:
            QMessageBox.critical(self, "ì˜¤ë¥˜", str(e))

    # -------- í™˜ê²½ì„¤ì • --------
    def on_open_settings_dialog(self):
        dlg = SettingsDialog(self, self.app_cfg)
        if dlg.exec() == QDialog.Accepted:
            new_cfg = dlg.get_settings()
            # UI ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
            self.cb_auto_buy.setChecked(getattr(new_cfg, "auto_buy", False))
            self.cb_auto_sell.setChecked(getattr(new_cfg, "auto_sell", False))
            # ì €ì¥
            self.store.save(new_cfg)
            self.app_cfg = new_cfg
            # Wiring ì ìš©
            if self.wiring:
                self.wiring.apply_settings(new_cfg)
            self.append_log("âš™ï¸ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # -------- ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸° --------
    def _open_macd_dialog(self, code: str):
        code6 = str(code)[-6:].zfill(6)
        dlg = self._macd_dialogs.get(code6)
        if dlg and dlg.isVisible():
            dlg.raise_(); dlg.activateWindow(); return

        self._ensure_macd_stream(code6)

        dlg = MacdDialog(code=code6, parent=self)
        dlg.finished.connect(lambda _: self._macd_dialogs.pop(code6, None))
        dlg.show()
        self._macd_dialogs[code6] = dlg

    # -------- ë¸Œë¦¬ì§€ â†’ UI --------
    @Slot(str)
    def append_log(self, text: str):
        self.text_log.append(str(text))

    @Slot(list)
    def populate_conditions(self, conditions: list):
        self.list_conditions.clear()
        normalized = []
        for cond in (conditions or []):
            if isinstance(cond, dict):
                seq = str(cond.get("seq", "")).strip()
                name = str(cond.get("name", "(ì´ë¦„ ì—†ìŒ)")).strip()
            elif isinstance(cond, (list, tuple)) and len(cond) >= 2:
                seq = str(cond[0]).strip()
                name = str(cond[1]).strip()
            else:
                continue
            if seq or name:
                normalized.append({"seq": seq, "name": name})

        for c in normalized:
            item = QListWidgetItem(f"[{c['seq']}] {c['name']}")
            item.setData(Qt.UserRole, c['seq'])
            self.list_conditions.addItem(item)

        self._update_cond_info()
        self.append_log(f"âœ… ì¡°ê±´ì‹ {len(normalized)}ê°œ ë¡œë“œ")

    @Slot(str)
    def on_new_stock(self, code: str):
        self.label_new_stock.setText(f"ì‹ ê·œ ì¢…ëª©: {code}")
        self.status.showMessage(f"ì‹ ê·œ ì¢…ëª©: {code}", 3000)

    @Slot(str, float, float, float)
    def on_macd_data(self, code: str, macd: float, signal: float, hist: float):
        code6 = str(code)[-6:].zfill(6)
        self.status.showMessage(f"[MACD] {code6} M:{macd:.2f} S:{signal:.2f} H:{hist:.2f}", 2500)
        logger.info(f"[MACD] {code6} | MACD:{macd:.2f} Signal:{signal:.2f} Hist:{hist:.2f}")

    @Slot(dict)
    def on_macd_series_ready(self, data: dict):
        code = data.get("code")
        tf = (data.get("tf") or "").lower()
        series = data.get("series") or data.get("values")
        if not code or not tf or not series:
            return
        code6 = str(code)[-6:].zfill(6)
        logger.info("[ui_main] on_macd_series_ready: %s", code6)

    # ---- ë³€í™˜/ë„ìš°ë¯¸ ----
    def _ensure_macd_stream(self, code6: str):
        try:
            now = pd.Timestamp.now(tz="Asia/Seoul")
            last = self._last_stream_req_ts.get(code6)
            if last is not None and (now - last).total_seconds() < getattr(self, "_stream_debounce_sec", 15):
                logger.debug("debounce: skip start_macd_stream for %s", code6)
                return
            self._last_stream_req_ts[code6] = now

            if code6 in self._active_macd_streams:
                logger.debug("start_macd_stream: already active for %s", code6)
                return

            if hasattr(self.engine, "start_macd_stream"):
                self.engine.start_macd_stream(code6)
                self._active_macd_streams.add(code6)
                logger.info("âœ… started MACD stream for %s (UI ensure)", code6)
            else:
                logger.warning("engine has no start_macd_stream")
        except Exception as e:
            logger.warning("start_macd_stream failed for %s: %s", code6, e)

    def _fmt_num(self, v, digits=0):
        try:
            if v is None or v == "":
                return "-"
            f = float(str(v).replace(",", "").replace("%", ""))
            if digits:
                return f"{f:,.{digits}f}"
            return f"{int(round(f)):,.0f}"
        except Exception:
            return str(v)

    def _fmt_time(self, ts):
        try:
            if isinstance(ts, pd.Timestamp):
                if ts.tzinfo is None:
                    ts = ts.tz_localize("Asia/Seoul")
                return ts.strftime("%H:%M:%S")
            return pd.Timestamp(ts).tz_localize("Asia/Seoul").strftime("%H:%M:%S")
        except Exception:
            return "-"

    # -------- ê²°ê³¼í‘œ ë Œë”ë§ --------
    def _render_results_html(self):
        if not self._result_rows:
            self.text_result.setHtml("<div style='color:#9aa0a6;'>í‘œì‹œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>")
            return

        key_map = {
            "ë“±ë½ë¥ (%)": "rt",
            "í˜„ì¬ê°€": "price",
            "ê±°ë˜ëŸ‰": "vol",
            "ë§¤ìˆ˜ê°€": "buy_price",
            "ë§¤ë„ê°€": "sell_price",
            "ì½”ë“œ": "code",
            "ì´ë¦„": "name",
            "ìµœê·¼ ê°±ì‹ ì‹œê°„": "updated_at",
        }
        sort_label = self.cmb_sort_key.currentText() if hasattr(self, "cmb_sort_key") else "ìµœê·¼ ê°±ì‹ ì‹œê°„"
        key = key_map.get(sort_label, "updated_at")
        desc = self.btn_sort_dir.isChecked() if hasattr(self, "btn_sort_dir") else True

        def sort_key(row):
            v = row.get(key)
            if key == "updated_at":
                try:
                    ts = v if isinstance(v, pd.Timestamp) else pd.Timestamp(v)
                    if ts.tzinfo is None:
                        ts = ts.tz_localize("Asia/Seoul")
                    return ts.timestamp()
                except Exception:
                    return 0
            try:
                return float(str(v).replace("%", "").replace(",", ""))
            except Exception:
                return str(v)

        rows = sorted(self._result_rows, key=sort_key, reverse=desc)

        html = [
            """
            <style>
              table.res { width:100%; border-collapse:collapse; font-size:12px; }
              table.res th, table.res td { border-bottom:1px solid #2f3338; padding:8px 10px; }
              table.res th { text-align:center; color:#cfd3d8; background:#25282d; position:sticky; top:0; }
              table.res td.right { text-align:right; font-family:Consolas,'Courier New',monospace; }
              table.res tr:hover { background:#2a2e33; }
              .pos { color:#e53935; font-weight:700; }
              .neg { color:#43a047; font-weight:700; }
              .muted { color:#9aa0a6; }
              .code { color:#9aa0a6; font-family:Consolas,'Courier New',monospace; }
              .btn { padding:2px 8px; border:1px solid #4c566a; border-radius:10px; color:#e0e0e0; text-decoration:none; background:#2b2f36; }
            </style>
            <table class="res">
              <thead>
                <tr>
                  <th style="width:24%;">ì´ë¦„</th>
                  <th style="width:12%;">ì½”ë“œ</th>
                  <th style="width:12%;">í˜„ì¬ê°€</th>
                  <th style="width:11%;">ë“±ë½ë¥ </th>
                  <th style="width:11%;">ë§¤ìˆ˜ê°€</th>
                  <th style="width:11%;">ë§¤ë„ê°€</th>
                  <th style="width:11%;">ìµœê·¼ ê°±ì‹ </th>
                  <th style="width:8%;"></th>
                </tr>
              </thead>
              <tbody>
            """
        ]

        for r in rows:
            name  = r.get("name","-")
            code6 = r.get("code","-")
            price = self._fmt_num(r.get("price"))
            rtval = r.get("rt", 0.0)
            try:
                f_rt = float(str(rtval).replace("%", "").replace(",", ""))
            except Exception:
                f_rt = 0.0
            cls = "pos" if f_rt > 0 else ("neg" if f_rt < 0 else "muted")
            rtf = f"{f_rt:.2f}%"

            buy_price  = self._fmt_num(r.get("buy_price"))
            sell_price = self._fmt_num(r.get("sell_price"))
            upd  = self._fmt_time(r.get("updated_at"))

            html.append(
                f"""
                <tr>
                  <td>{name}</td>
                  <td class="code">{code6}</td>
                  <td class="right">{price}</td>
                  <td class="right {cls}">{rtf}</td>
                  <td class="right">{buy_price}</td>
                  <td class="right">{sell_price}</td>
                  <td class="right">{upd}</td>
                  <td><a href="macd:{code6}" class="btn">ìƒì„¸</a></td>
                </tr>
                """
            )

        html.append("</tbody></table>")
        self.text_result.setHtml("".join(html))

    # ---- ì‹ ê·œ ì¢…ëª© ìƒì„¸ ìˆ˜ì‹  ----
    @Slot(dict)
    def on_new_stock_detail(self, payload: dict):
        row0 = None
        if isinstance(payload.get("open_pric_pre_flu_rt"), list) and payload["open_pric_pre_flu_rt"]:
            row0 = payload["open_pric_pre_flu_rt"][0]
        elif isinstance(payload.get("rows"), list) and payload["rows"]:
            row0 = payload["rows"][0]

        flat = dict(payload)
        if isinstance(row0, dict):
            for k, v in row0.items():
                flat.setdefault(k, v)

        code = (flat.get("stock_code") or "").strip()
        name = flat.get("stock_name") or flat.get("stk_nm") or flat.get("isu_nm") or "ì¢…ëª©ëª… ì—†ìŒ"

        def _num(keys):
            for k in keys:
                v = flat.get(k)
                if v not in (None, "", "-"):
                    try:
                        return float(str(v).replace(",", "").replace("%",""))
                    except Exception:
                        pass
            return None

        price = _num(["cur_prc","stck_prpr","price"])
        rt    = _num(["flu_rt","prdy_ctrt"])
        vol   = _num(["now_trde_qty","acml_vol","trqu"])

        code6 = str(code)[-6:].zfill(6) if code else ""
        if not code6:
            return

        updated_at = pd.Timestamp.now(tz="Asia/Seoul")

        row = {
            "code": code6,
            "name": name or "-",
            "price": price,
            "rt": rt if rt is not None else 0.0,
            "vol": vol,
            "buy_price": None,         # ì‹ ê·œ ì»¬ëŸ¼
            "sell_price": None,        # ì‹ ê·œ ì»¬ëŸ¼
            "updated_at": updated_at,
        }

        idx = self._result_index.get(code6)
        if idx is None:
            self._result_index[code6] = len(self._result_rows)
            self._result_rows.append(row)
        else:
            # ìƒˆ ë°ì´í„°ë¡œ ë®ë˜, ê¸°ì¡´ buy/sell ì´ë ¥ì€ ë³´ì¡´
            keep_buy = self._result_rows[idx].get("buy_price")
            keep_sell = self._result_rows[idx].get("sell_price")
            if keep_buy is not None:
                row["buy_price"] = keep_buy
            if keep_sell is not None:
                row["sell_price"] = keep_sell
            self._result_rows[idx] = row

        self.label_new_stock.setText(f"ì‹ ê·œ ì¢…ëª©: {code6}")

        self._render_results_html()
        self._ensure_macd_stream(code6)

    # ---- ë§¤ìˆ˜/ë§¤ë„ ì‹ í˜¸ ìˆ˜ì‹  â†’ í‘œ ê°±ì‹  ----
    @Slot(dict)
    def on_trade_signal(self, payload: dict):
        """
        {"side":"BUY"|"SELL", "code":"166090", "price": 41700, "ts": ...}
        """
        try:
            side = str(payload.get("side", "")).upper()
            code6 = str(payload.get("code", "")).zfill(6)[-6:]
            price = payload.get("price")

            if not code6 or price in (None, ""):
                return

            idx = self._result_index.get(code6)
            if idx is None:
                # í…Œì´ë¸”ì— ì•„ì§ ì—†ëŠ” ì¢…ëª©ì´ë©´ í–‰ì„ ì‹ ê·œ ìƒì„±
                row = {
                    "code": code6,
                    "name": code6,
                    "price": None,
                    "rt": 0.0,
                    "vol": None,
                    "buy_price": None,
                    "sell_price": None,
                    "updated_at": pd.Timestamp.now(tz="Asia/Seoul"),
                }
                self._result_index[code6] = len(self._result_rows)
                self._result_rows.append(row)
                idx = self._result_index[code6]

            row = self._result_rows[idx]
            if side == "BUY":
                row["buy_price"] = float(price)
            elif side == "SELL":
                row["sell_price"] = float(price)

            row["updated_at"] = pd.Timestamp.now(tz="Asia/Seoul")
            self._render_results_html()
        except Exception as e:
            self.append_log(f"[UI] on_trade_signal ì˜¤ë¥˜: {e}")

    # -------- ë§í¬ í´ë¦­(ìƒì„¸) í•¸ë“¤ëŸ¬ --------
    @Slot(QUrl)
    def _on_result_anchor_clicked(self, url: QUrl):
        try:
            if not url or url.scheme() != 'macd':
                return
            code = url.path().lstrip('/') or url.host() or url.toString()[5:]
            if code:
                self._open_macd_dialog(code)
        except Exception as e:
            logger.error(f"anchor click error: {e}")

    # -------- í›„ë³´ ë¡œë”©/ê²€ìƒ‰ --------
    def load_candidates(self, path: str = None):
        if path is None:
            path = os.path.join(self.project_root, "candidate_stocks.csv")

        if not os.path.exists(path):
            self.append_log(f"â„¹ï¸ í›„ë³´ ì¢…ëª© íŒŒì¼ ì—†ìŒ: {path}")
            self.cand_model.setDataFrame(pd.DataFrame(columns=["íšŒì‚¬ëª…", "ì¢…ëª©ì½”ë“œ", "í˜„ì¬ê°€"]))
            return

        try:
            df = pd.read_csv(path, encoding="utf-8-sig")
            rename_map = {}
            for col in list(df.columns):
                low = col.lower()
                if low in {"stock_name", "name", "ì¢…ëª©ëª…", "kor_name"}:
                    rename_map[col] = "íšŒì‚¬ëª…"
                elif low in {"stock_code", "code", "ì¢…ëª©ì½”ë“œ", "ticker"}:
                    rename_map[col] = "ì¢…ëª©ì½”ë“œ"
                elif low in {"price", "í˜„ì¬ê°€", "close", "prc"}:
                    rename_map[col] = "í˜„ì¬ê°€"
            if rename_map:
                df = df.rename(columns=rename_map)
            for need in ["íšŒì‚¬ëª…", "ì¢…ëª©ì½”ë“œ", "í˜„ì¬ê°€"]:
                if need not in df.columns:
                    df[need] = ""

            df = df[["íšŒì‚¬ëª…", "ì¢…ëª©ì½”ë“œ", "í˜„ì¬ê°€"]]
            self.cand_model.setDataFrame(df)
            self._filter_candidates(self.search_candidates.text())
            self.status.showMessage(f"í›„ë³´ ì¢…ëª© {len(df)}ê±´ ë¡œë“œ", 3000)
        except Exception as e:
            self.append_log(f"âŒ í›„ë³´ ì¢…ëª© íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: {e}")

    def _filter_conditions(self, text: str):
        text = (text or "").strip().lower()
        for i in range(self.list_conditions.count()):
            item = self.list_conditions.item(i)
            visible = (text in item.text().lower()) if text else True
            item.setHidden(not visible)
        self._update_cond_info()

    def _filter_candidates(self, text: str):
        self.cand_proxy.setFilterFixedString(text or "")

    def _update_cond_info(self):
        total = self.list_conditions.count()
        selected = len(self.list_conditions.selectedItems())
        self.lbl_cond_info.setText(f"{total}ê°œ / ì„ íƒ: {selected}")
